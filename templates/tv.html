<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>auto-farm TV Monitor</title>
    <style>
        body { background: #111; color: #fff; font-family: Arial, sans-serif; margin: 0; }
        .tv-container { max-width: 100vw; width: 100vw; margin: 0; padding: 0; }
        .tv-header { background: #222; padding: 1rem 2vw; font-size: 2.2rem; font-weight: bold; letter-spacing: 0.1em; display: flex; justify-content: space-between; align-items: center; }
        .home-btn { background: #444; color: #fff; text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.5rem; font-size: 1.2rem; font-weight: normal; letter-spacing: normal; transition: background 0.2s; }
        .home-btn:hover { background: #666; }
        .tv-row { display: flex; flex-wrap: wrap; gap: 2vw; padding: 2vw; }
        .tv-col { flex: 1 1 0; min-width: 320px; max-width: 48vw; background: #181818; border-radius: 1vw; padding: 2vw; margin-bottom: 2vw; box-shadow: 0 2px 16px #0008; }
        .tv-title { font-size: 1.5rem; margin-bottom: 1vw; color: #6cf; }
        .tv-data p { font-size: 1.3rem; margin: 0.5vw 0; }
        .tv-image { text-align: center; }
        .tv-image img { max-width: 100%; max-height: 32vw; border-radius: 1vw; box-shadow: 0 2px 8px #000a; background: #222; }
        .tv-badges { display: flex; flex-wrap: wrap; gap: 0.7vw; margin-top: 1vw; }
        .tv-badge { padding: 0.7vw 1.2vw; border-radius: 2vw; font-size: 1.1rem; background: #444; color: #fff; }
        .tv-badge.active { background: #28a745; }
        .tv-badge.inactive { background: #666; }
        .tv-time { font-size: 1.1rem; color: #aaa; margin-bottom: 1vw; }
        @media (max-width: 900px) {
            .tv-row { flex-direction: column; gap: 2vw; }
            .tv-col { max-width: 100vw; }
            .tv-image img { max-height: 50vw; }
        }
    </style>
</head>
<body>
    <div class="tv-header">
        <span>auto-farm TV Monitor</span>
        <a href="/" class="home-btn">&#8962; Home</a>
    </div>
    <div class="tv-container">
        <div class="tv-row">
            <div class="tv-col">
                <div class="tv-title">Current Readings</div>
                <div class="tv-data" id="data">
                    <p>Temperature: <strong id="temp">--</strong> Â°F</p>
                    <p>Humidity: <strong id="humidity">--</strong> %</p>
                    <p>Soil Moisture A: <strong id="hyd_a">--</strong> %</p>
                    <p>Soil Moisture B: <strong id="hyd_b">--</strong> %</p>
                    <p>Fan Speed: <strong id="fan">--</strong></p>
                </div>
                <div class="tv-title" style="margin-top:2vw;">Trigger Statuses</div>
                <div class="tv-badges" id="trigger-pills"></div>
                <div class="tv-title" style="margin-top:2vw;">Database Info</div>
                <div class="tv-data" id="db-info">
                    <p>Records: <strong id="record-count">--</strong></p>
                    <p>Size: <strong id="db-size">--</strong></p>
                </div>
            </div>
            <div class="tv-col">
                <div class="tv-title" style="margin-top:2vw;">Latest Webcam Image</div>
                <div class="tv-image">
                    <img id="latest-image" src="" alt="Latest Webcam Image">
                    <div id="latest-image-info" class="tv-time"></div>
                </div>
            </div>
        </div>
        <div class="tv-time" id="server-time">Server Time: --:--:--</div>
    </div>
    <script>
    function updateData() {
        fetch('/api/data').then(res => res.json()).then(data => {
            if (!data) return;
            document.getElementById('temp').textContent = data.temp_f ?? '--';
            document.getElementById('humidity').textContent = data.humidity ?? '--';
            document.getElementById('hyd_a').textContent = data.hydrometer_a ?? '--';
            document.getElementById('hyd_b').textContent = data.hydrometer_b ?? '--';
            document.getElementById('fan').textContent = data.fan_signal ?? '--';
        });
    }
    function updateTriggers() {
        fetch('/api/triggers').then(res => res.json()).then(triggers => {
            const pills = triggers.map(trigger => {
                const pillClass = trigger.active ? 'tv-badge active' : 'tv-badge inactive';
                return `<span class="${pillClass}" title="${trigger.name}">${trigger.name}</span>`;
            }).join(' ');
            document.getElementById('trigger-pills').innerHTML = pills;
        });
    }
    function updateDbInfo() {
        fetch('/api/db_info').then(res => res.json()).then(info => {
            document.getElementById('record-count').textContent = info.record_count ?? '--';
            document.getElementById('db-size').textContent = info.db_size ? (info.db_size / (1024 * 1024)).toFixed(2) + ' MB' : '--';
        });
    }
    function updateServerTime() {
        fetch('/api/time').then(res => res.json()).then(data => {
            if (data && data.timestamp) {
                const d = new Date(data.timestamp);
                document.getElementById('server-time').textContent = 'Server Time: ' + d.toLocaleString();
            }
        });
    }
    function updateImage() {
        fetch('/api/camera/latest').then(res => res.json()).then(data => {
            if (data && data.filename) {
                const img = document.getElementById('latest-image');
                img.src = `/camera/images/${data.filename}?t=${Date.now()}`;
                document.getElementById('latest-image-info').textContent = new Date(data.timestamp).toLocaleString();
            }
        });
    }
    
    function refreshCamera() {
        fetch('/api/camera/capture', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify({ trigger_event: 'TV Monitor Refresh' })
        }).then(res => res.json()).then(data => {
            if (data && data.filename) {
                updateImage();
            }
        }).catch(err => console.error("Error refreshing camera:", err));
    }

    // Initial load
    updateData();
    updateTriggers();
    updateDbInfo();
    updateServerTime();
    updateImage();
    refreshCamera();
    setInterval(updateData, 5000);
    setInterval(updateTriggers, 5000);
    setInterval(updateDbInfo, 15000);
    setInterval(updateServerTime, 10000);
    setInterval(updateImage, 10000);
    setInterval(refreshCamera, 60000);
    </script>
</body>
</html>